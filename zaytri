#!/bin/bash
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Zaytri â€” CLI
# A single command to manage the entire Zaytri system.
#
# Usage:
#   zaytri start               Start all services (local)
#   zaytri stop                Stop all services
#   zaytri restart             Stop + Start
#   zaytri build               Run tests + build production
#   zaytri status              Show service health
#   zaytri logs                Tail all service logs
#   zaytri test                Run test suite only
#   zaytri docker up           Start via Docker Compose
#   zaytri docker down         Stop Docker containers
#   zaytri docker logs         Docker Compose logs
#   zaytri docker build        Build Docker images
#   zaytri chat <message>      Send a quick message to the Master Agent
#   zaytri rag-check           Check RAG embedding health for a brand
#   zaytri rag-test             Test RAG retrieval for a brand + query
#   zaytri rag-debug            Full RAG pipeline debug report
#   zaytri demo <brand>         Run deterministic RAG demo
#   zaytri embed --brand <name> Generate pgvector embeddings for a brand
#   zaytri config              Show current port & env config
#   zaytri flush-redis         Clear Redis cache
#   zaytri update              Pull latest code + re-install deps
#   zaytri uninstall           Remove Zaytri
#   zaytri help                Show this help
#   zaytri version             Show version
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€ Resolve install directory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Works whether invoked via symlink, PATH, or directly
SCRIPT_SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_SOURCE" ]; do
    DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"
    SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
    [[ $SCRIPT_SOURCE != /* ]] && SCRIPT_SOURCE="$DIR/$SCRIPT_SOURCE"
done
ZAYTRI_HOME="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"

# â”€â”€â”€ Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

VERSION="1.0.0"

# â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log()      { echo -e "${CYAN}[zaytri]${NC} $1"; }
log_ok()   { echo -e "${GREEN}[zaytri]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[zaytri]${NC} $1"; }
log_err()  { echo -e "${RED}[zaytri]${NC} $1"; }

banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
 
 ______              _            
|___  /             | |       
   / /  __ _ _   _  | |_ _ __  _
  / /  / _` | | | || __ | '_ || |
 / /__| (_| | |_| | | |_| |   | |
\_____/\__,_|\__, |  \__|_|   |_| -------------------------------------------------
               __/ |              Welcome to Zaytri! - AI Orchestration Engine
              |___/               

EOF
    echo -e "${NC}"
    echo -e "  ${BOLD}v${VERSION}${NC} â€” Built by ${BOLD}Abhishek ${NC}"
    echo ""
}

load_env() {
    if [ -f "$ZAYTRI_HOME/.env" ]; then
        set -a
        source "$ZAYTRI_HOME/.env"
        set +a
    fi
    BACKEND_PORT="${BACKEND_PORT:-8000}"
    FRONTEND_PORT="${FRONTEND_PORT:-3000}"
    REDIS_PORT="${REDIS_PORT:-6379}"
    POSTGRES_PORT="${POSTGRES_PORT:-5432}"
    OLLAMA_PORT="${OLLAMA_PORT:-11434}"
}

resolve_python() {
    if [ -d "$ZAYTRI_HOME/.venv" ]; then
        PYTHON="$ZAYTRI_HOME/.venv/bin/python3"
    else
        PYTHON="python3"
    fi
}

ensure_home() {
    if [ ! -f "$ZAYTRI_HOME/main.py" ]; then
        log_err "Zaytri not found at $ZAYTRI_HOME"
        log_err "Run the installer first: curl -fsSL <repo>/install.sh | bash"
        exit 1
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Commands
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cmd_start() {
    ensure_home
    load_env
    banner
    log "Starting Zaytri services..."
    bash "$ZAYTRI_HOME/scripts/start.sh" "$@"
}

cmd_stop() {
    ensure_home
    load_env
    log "Stopping Zaytri services..."
    bash "$ZAYTRI_HOME/scripts/stop.sh" "$@"
}

cmd_restart() {
    cmd_stop "$@"
    sleep 1
    cmd_start "$@"
}

cmd_build() {
    ensure_home
    load_env
    banner
    bash "$ZAYTRI_HOME/scripts/build.sh" "$@"
}

cmd_test() {
    ensure_home
    load_env
    bash "$ZAYTRI_HOME/scripts/build.sh" --tests-only
}

cmd_status() {
    ensure_home
    load_env
    banner

    echo -e "${BOLD}Service Health${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # Backend
    if curl -sf "http://localhost:${BACKEND_PORT}/health" &>/dev/null; then
        log_ok "  Backend  (port ${BACKEND_PORT}): âœ… Running"
    else
        log_err "  Backend  (port ${BACKEND_PORT}): âŒ Not responding"
    fi

    # Frontend
    if curl -sf "http://localhost:${FRONTEND_PORT}" &>/dev/null; then
        log_ok "  Frontend (port ${FRONTEND_PORT}): âœ… Running"
    else
        log_err "  Frontend (port ${FRONTEND_PORT}): âŒ Not responding"
    fi

    # Redis
    if command -v redis-cli &>/dev/null && redis-cli -p "$REDIS_PORT" ping &>/dev/null; then
        log_ok "  Redis    (port ${REDIS_PORT}): âœ… Running"
    elif lsof -ti ":${REDIS_PORT}" &>/dev/null; then
        log_ok "  Redis    (port ${REDIS_PORT}): âœ… Port in use"
    else
        log_err "  Redis    (port ${REDIS_PORT}): âŒ Not running"
    fi

    # PostgreSQL
    if lsof -ti ":${POSTGRES_PORT}" &>/dev/null; then
        log_ok "  Postgres (port ${POSTGRES_PORT}): âœ… Running"
    else
        log_err "  Postgres (port ${POSTGRES_PORT}): âŒ Not running"
    fi

    # Ollama
    if curl -sf "http://localhost:${OLLAMA_PORT}/api/tags" &>/dev/null; then
        log_ok "  Ollama   (port ${OLLAMA_PORT}): âœ… Running"
    else
        log_err "  Ollama   (port ${OLLAMA_PORT}): âŒ Not running"
    fi

    echo ""
    if [ -d "$ZAYTRI_HOME/.venv" ]; then
        log_ok "  Environment: ðŸ“¦ .venv (Local)"
    else
        log_warn "  Environment: ðŸŒ System (Global)"
    fi

    echo ""
    echo -e "${BOLD}Endpoints${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "  ðŸŒ App:      http://localhost:${FRONTEND_PORT}"
    echo "  ðŸ¤– Chat:     http://localhost:${FRONTEND_PORT}/chat"
    echo "  ðŸ”§ API:      http://localhost:${BACKEND_PORT}"
    echo "  ðŸ“š API Docs: http://localhost:${BACKEND_PORT}/docs"
    echo ""
}

cmd_config() {
    ensure_home
    load_env
    banner

    echo -e "${BOLD}Current Configuration${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    echo -e "${CYAN}${BOLD}[ System ]${NC}"
    echo "  Install Dir:    ${ZAYTRI_HOME}"
    echo "  Environment:    ${APP_ENV:-development}"
    echo "  Debug Mode:     ${APP_DEBUG:-true}"
    echo "  Log Level:      ${LOG_LEVEL:-INFO}"
    echo ""

    echo -e "${CYAN}${BOLD}[ Ports & Endpoints ]${NC}"
    echo "  Backend Port:   ${BACKEND_PORT}"
    echo "  Frontend Port:  ${FRONTEND_PORT}"
    echo "  Redis Port:     ${REDIS_PORT}"
    echo "  Postgres Port:  ${POSTGRES_PORT}"
    echo "  Ollama Port:    ${OLLAMA_PORT}"
    echo "  API URL:        ${NEXT_PUBLIC_API_URL:-http://localhost:${BACKEND_PORT}}"
    echo ""

    echo -e "${CYAN}${BOLD}[ AI / LLM ]${NC}"
    echo -e "  Ollama Model:   ${GREEN}${OLLAMA_MODEL:-mistral}${NC} ${DIM}(Host: ${OLLAMA_HOST:-http://localhost:${OLLAMA_PORT}})${NC}"
    
    if [ -n "$OPEN_ROUTER_API_KEY" ]; then
        echo -e "  OpenRouter:     ${GREEN}âœ“ Enabled${NC} ${DIM}(****${OPEN_ROUTER_API_KEY: -4})${NC}"
    else
        echo -e "  OpenRouter:     ${RED}âœ— Disabled${NC}"
    fi
    echo ""

    echo -e "${CYAN}${BOLD}[ Database & Cache ]${NC}"
    if [ -n "$DATABASE_URL" ]; then
        # Mask password in DATABASE_URL: postgresql+asyncpg://user:pass@host:port/db
        DB_CLEAN=$(echo "$DATABASE_URL" | sed 's/\/\/.*:.*@/\/\/****:****@/')
        echo "  Postgres URL:   ${DB_CLEAN}"
    else
        echo -e "  Postgres URL:   ${RED}Not Configured${NC}"
    fi
    echo "  Redis URL:      ${REDIS_URL:-redis://localhost:${REDIS_PORT}/0}"
    echo ""

    echo -e "${CYAN}${BOLD}[ Platforms / Integrations ]${NC}"
    
    # Function to print integration status
    print_status() {
        local label=$1
        local value=$2
        printf "  %-15s " "$label:"
        if [ -n "$value" ] && [ "$value" != "your_api_key" ] && [ "$value" != "your_token" ] && [ "$value" != "your_secret_key" ]; then
            echo -e "${GREEN}âœ“ Configured${NC}"
        else
            echo -e "${DIM}Not Configured${NC}"
        fi
    }

    print_status "Instagram" "$INSTAGRAM_ACCESS_TOKEN"
    print_status "Facebook"  "$FACEBOOK_ACCESS_TOKEN"
    print_status "Twitter/X"  "$TWITTER_API_KEY"
    print_status "WhatsApp"   "$WHATSAPP_ACCESS_TOKEN"
    print_status "YouTube"    "$YOUTUBE_API_KEY"
    print_status "LinkedIn"   "$OAUTH_LINKEDIN_CLIENT_ID"
    print_status "Google"     "$OAUTH_GOOGLE_CLIENT_ID"
    print_status "GitHub"     "$OAUTH_GITHUB_CLIENT_ID"
    echo ""

    echo -e "${DIM}.env source: ${ZAYTRI_HOME}/.env${NC}"
    echo ""
}

cmd_logs() {
    ensure_home
    load_env
    log "Tailing logs (Ctrl+C to stop)..."
    echo ""

    # Find log files or tail processes
    if [ -d "$ZAYTRI_HOME/logs" ]; then
        tail -f "$ZAYTRI_HOME/logs/"*.log 2>/dev/null
    else
        # Tail the process output
        log_warn "No log directory found. Showing process list:"
        echo ""
        ps aux | grep -E "(uvicorn|celery|next)" | grep -v grep || log "No Zaytri processes found."
    fi
}

cmd_chat() {
    ensure_home
    load_env
    local message="$*"
    if [ -z "$message" ]; then
        log_err "Usage: zaytri chat \"your message here\""
        exit 1
    fi

    local api_url="http://localhost:${BACKEND_PORT}"
    local response
    resolve_python
    response=$(curl -sf -X POST "${api_url}/chat" \
        -H "Content-Type: application/json" \
        -d "{\"message\": \"${message}\", \"conversation_id\": \"cli-$(date +%s)\"}" 2>&1)

    if [ $? -eq 0 ]; then
        # Extract response field from JSON
        echo "$response" | $PYTHON -c "
import sys, json
data = json.load(sys.stdin)
print(data.get('response', data))
" 2>/dev/null || echo "$response"
    else
        log_err "Could not reach backend at ${api_url}"
        log_err "Is Zaytri running? Try: zaytri start"
    fi
}

cmd_flush_redis() {
    ensure_home
    load_env
    if command -v redis-cli &>/dev/null; then
        redis-cli -p "$REDIS_PORT" FLUSHALL
        log_ok "Redis cache cleared âœ…"
    else
        log_err "redis-cli not found. Install Redis tools."
    fi
}

cmd_update() {
    ensure_home
    log "Updating Zaytri..."
    cd "$ZAYTRI_HOME"

    resolve_python
    git pull origin main 2>/dev/null || git pull 2>/dev/null
    log_ok "  âœ“ Code updated"

    if [ -f requirements.txt ]; then
        if [ -d "$ZAYTRI_HOME/.venv" ]; then
            "$ZAYTRI_HOME/.venv/bin/pip" install -r requirements.txt --quiet
            log_ok "  âœ“ Python deps updated in .venv"
        else
            pip3 install -r requirements.txt --quiet 2>/dev/null || \
                python3 -m pip install -r requirements.txt --quiet 2>/dev/null
            log_ok "  âœ“ Python deps updated (system)"
        fi
    fi

    if [ -d frontend ]; then
        cd frontend && npm ci --silent 2>/dev/null || npm install --silent 2>/dev/null
        cd "$ZAYTRI_HOME"
        log_ok "  âœ“ Frontend deps updated"
    fi

    log_ok "Update complete! Restart with: zaytri restart"
}

cmd_uninstall() {
    ensure_home
    echo ""
    log_warn "âš ï¸  This will:"
    echo "  1. Stop all Zaytri services"
    echo "  2. Remove ${ZAYTRI_HOME}"
    echo "  3. Remove the 'zaytri' command"
    echo ""
    read -p "Are you sure? (type 'yes' to confirm): " confirm
    if [ "$confirm" != "yes" ]; then
        log "Cancelled."
        exit 0
    fi

    cmd_stop 2>/dev/null || true

    # Remove symlink
    for link in /usr/local/bin/zaytri "$HOME/.local/bin/zaytri" "$HOME/bin/zaytri"; do
        if [ -L "$link" ]; then
            if [ -w "$link" ] || [ -w "$(dirname "$link")" ]; then
                rm -f "$link" 2>/dev/null && log_ok "  âœ“ Removed ${link}"
            else
                sudo rm -f "$link" 2>/dev/null && log_ok "  âœ“ Removed ${link} (via sudo)"
            fi
        fi
    done

    rm -rf "$ZAYTRI_HOME"
    log_ok "Zaytri uninstalled. Goodbye! ðŸ‘‹"
}

# â”€â”€â”€ Docker sub-commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_docker() {
    ensure_home
    load_env
    cd "$ZAYTRI_HOME"

    case "${1:-up}" in
        up|start)
            banner
            log "Starting via Docker Compose..."
            docker compose up --build -d
            echo ""
            log_ok "Zaytri is running! ðŸš€"
            log "  ðŸŒ http://localhost:${FRONTEND_PORT}"
            log "  ðŸ”§ http://localhost:${BACKEND_PORT}/docs"
            ;;
        down|stop)
            log "Stopping Docker containers..."
            docker compose down
            log_ok "All containers stopped."
            ;;
        logs)
            docker compose logs -f --tail=100
            ;;
        build)
            log "Building Docker images..."
            docker compose build
            log_ok "Build complete."
            ;;
        restart)
            docker compose down
            docker compose up --build -d
            log_ok "Restarted! ðŸš€"
            ;;
        ps|status)
            docker compose ps
            ;;
        *)
            log_err "Unknown docker command: $1"
            echo "  Usage: zaytri docker [up|down|logs|build|restart|ps]"
            exit 1
            ;;
    esac
}

# â”€â”€â”€ Production Deployment sub-commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_deploy() {
    ensure_home
    local DEPLOY_SCRIPT="$ZAYTRI_HOME/scripts/deploy-prod.sh"
    
    if [ ! -f "$DEPLOY_SCRIPT" ]; then
        log_err "Deployment script not found at $DEPLOY_SCRIPT"
        exit 1
    fi

    local action="$1"
    shift 2>/dev/null || true
    
    # If no action provided, show deployment help
    if [ -z "$action" ]; then
        bash "$DEPLOY_SCRIPT" help
        return
    fi

    # Dispatch to the production deployment script
    bash "$DEPLOY_SCRIPT" "$action" "$@"
}

# â”€â”€â”€ Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_help() {
    banner
    echo -e "${BOLD}Usage:${NC} zaytri <command> [options]"
    echo ""
    echo -e "${BOLD}Local Development:${NC}"
    echo "  start               Start all services (backend, frontend, celery)"
    echo "  stop                Stop all services"
    echo "  restart             Stop + Start"
    echo "  status              Check service health"
    echo "  logs                Tail service logs"
    echo "  config              Show current configuration"
    echo ""
    echo -e "${BOLD}Build & Test:${NC}"
    echo "  build               Run tests â†’ validate â†’ build production"
    echo "  test                Run test suite only"
    echo ""
    echo -e "${BOLD}Docker:${NC}"
    echo "  docker up           Start via Docker Compose"
    echo "  docker down         Stop Docker containers"
    echo "  docker logs         Docker Compose logs"
    echo "  docker build        Build Docker images"
    echo "  docker restart      Rebuild + restart containers"
    echo "  docker ps           Show container status"
    echo ""
    echo -e "${BOLD}Production (GCE):${NC}"
    echo "  deploy              Full deploy to Google Cloud (Mac -> VM)"
    echo "  remote-status       Check status of containers on VM"
    echo "  remote-logs [app]   View logs from the VM"
    echo "  ssl                 Obtain/renew SSL certificate on VM"
    echo "  vm-ssh              SSH into the production VM"
    echo ""
    echo -e "${BOLD}Utilities:${NC}"
    echo "  chat <message>      Send a message to the Master Agent"
    echo "  flush-redis         Clear Redis cache"
    echo "  update              Pull latest code + update dependencies"
    echo "  uninstall           Remove Zaytri completely"
    echo ""
    echo -e "${BOLD}RAG Pipeline:${NC}"
    echo "  rag-check           Check embedding health for a brand"
    echo "  rag-test            Test retrieval for a brand + query"
    echo "  rag-debug           Full RAG pipeline debug report"
    echo "  demo <brand>        Run deterministic RAG demo"
    echo "  embed               Generate pgvector embeddings for a brand"
    echo ""
    echo -e "${BOLD}Info:${NC}"
    echo "  help                Show this help"
    echo "  version             Show version"
    echo ""
    echo -e "${DIM}One-line install:${NC}"
    echo "  curl -fsSL https://raw.githubusercontent.com/abhishekthatguy/zaytri/main/install.sh | bash"
    echo ""
}

cmd_version() {
    echo "Zaytri v${VERSION}"
    echo "Built by Abhishek Singh (Avii)"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Router
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

COMMAND="${1:-help}"
shift 2>/dev/null || true

case "$COMMAND" in
    start)        cmd_start "$@" ;;
    stop)         cmd_stop "$@" ;;
    restart)      cmd_restart "$@" ;;
    build)        cmd_build "$@" ;;
    test)         cmd_test "$@" ;;
    status)       cmd_status "$@" ;;
    config)       cmd_config "$@" ;;
    logs)         cmd_logs "$@" ;;
    chat)         cmd_chat "$@" ;;
    flush-redis)  cmd_flush_redis "$@" ;;
    update)       cmd_update "$@" ;;
    uninstall)    cmd_uninstall "$@" ;;
    docker)       cmd_docker "$@" ;;
    deploy|remote-status|remote-logs|remote-restart|remote-up|remote-down|ssl|vm-ssh)
        cmd_deploy "$COMMAND" "$@"
        ;;
    rag-check|rag-test|rag-debug|demo|embed)
        resolve_python
        load_env
        cd "$ZAYTRI_HOME"
        $PYTHON -m cli.rag_commands "$COMMAND" "$@"
        ;;
    help|--help|-h) cmd_help ;;
    version|--version|-v) cmd_version ;;
    *)
        log_err "Unknown command: ${COMMAND}"
        echo "  Run 'zaytri help' for usage."
        exit 1
        ;;
esac
